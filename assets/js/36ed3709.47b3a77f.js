"use strict";(self.webpackChunknotes_hub=self.webpackChunknotes_hub||[]).push([[208],{3875:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>t,metadata:()=>r,toc:()=>d});var o=a(5893),i=a(1151);const t={sidebar_position:1},s="Main.py",r={id:"tutorial-basics/main",title:"Main.py",description:"Configuraci\xf3n e Importaci\xf3n de Bibliotecas",source:"@site/docs/tutorial-basics/main.md",sourceDirName:"tutorial-basics",slug:"/tutorial-basics/main",permalink:"/NotesHub-Documentation/docs/tutorial-basics/main",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tutorial-basics/main.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Estructura del C\xf3digo",permalink:"/NotesHub-Documentation/docs/category/estructura-del-c\xf3digo"},next:{title:"Scripts.sql",permalink:"/NotesHub-Documentation/docs/tutorial-basics/scripts"}},c={},d=[{value:"Configuraci\xf3n e Importaci\xf3n de Bibliotecas",id:"configuraci\xf3n-e-importaci\xf3n-de-bibliotecas",level:2},{value:"Configuraci\xf3n del Bot de Telegram",id:"configuraci\xf3n-del-bot-de-telegram",level:2},{value:"Configuraci\xf3n de Teclados Inline",id:"configuraci\xf3n-de-teclados-inline",level:2},{value:"Manejo de Callbacks",id:"manejo-de-callbacks",level:2},{value:"Manejo de Comandos",id:"manejo-de-comandos",level:2},{value:"Funciones de Procesamiento de Texto",id:"funciones-de-procesamiento-de-texto",level:2},{value:"Manejo de Mensajes de Usuario",id:"manejo-de-mensajes-de-usuario",level:2},{value:"Manejo de Documentos PDF",id:"manejo-de-documentos-pdf",level:2},{value:"Inicializaci\xf3n y Ejecuci\xf3n del Bot",id:"inicializaci\xf3n-y-ejecuci\xf3n-del-bot",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"mainpy",children:"Main.py"}),"\n",(0,o.jsx)(n.h2,{id:"configuraci\xf3n-e-importaci\xf3n-de-bibliotecas",children:"Configuraci\xf3n e Importaci\xf3n de Bibliotecas"}),"\n",(0,o.jsx)(n.p,{children:"Activaci\xf3n y desactivaci\xf3n del entorno virtual.\nImportaci\xf3n de bibliotecas necesarias como nltk, os, openai, etc.\nConfiguraci\xf3n de token encoding y variables de entorno."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:"# source myenv/bin/activate\n# deactivate\nimport nltk\nnltk.download('punkt')\nfrom dotenv import load_dotenv\nimport os\nimport openai\nfrom nltk.tokenize import sent_tokenize\nfrom aiogram.dispatcher.filters import Command, ContentTypeFilter\nfrom aiogram import Bot, Dispatcher, types\nfrom aiogram.types import Message, ContentType\nfrom aiogram.utils import executor\nfrom aiogram.dispatcher import FSMContext\nfrom aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, InputFile\nfrom utils import *\nfrom utils_db import *\nimport tempfile\nimport urllib.request\nimport ssl\nimport tiktoken\n"})}),"\n",(0,o.jsx)(n.h2,{id:"configuraci\xf3n-del-bot-de-telegram",children:"Configuraci\xf3n del Bot de Telegram"}),"\n",(0,o.jsx)(n.p,{children:"Configuraci\xf3n de variables relacionadas con el modelo GPT-3.5-turbo y el bot de Telegram.\nEstablecimiento de variables de entorno."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:'# Token encoding configuration\nenc = tiktoken.encoding_for_model("gpt-3.5-turbo")\n\ncost_by_in_token = 0.0000015\ncost_by_out_token = 0.000002\n\n# Disable SSL verification\nssl._create_default_https_context = ssl._create_unverified_context\n\nFILE_SIZE_LIMIT = 3 * 1024 * 1024 # 2 MB\ngptTurboRate = 0.002\ncwd = os.getcwd()\n\nload_dotenv()\nopenai.api_key = os.getenv("OPENAI_API_KEY")\ntelegram_username = os.getenv("TELEGRAM_BOT_USERNAME")\n\nbot = Bot(token=os.getenv("TELEGRAM_TOKEN"), parse_mode=\'HTML\')\ndp = Dispatcher(bot)\n'})}),"\n",(0,o.jsx)(n.h2,{id:"configuraci\xf3n-de-teclados-inline",children:"Configuraci\xf3n de Teclados Inline"}),"\n",(0,o.jsx)(n.p,{children:"Definici\xf3n de botones para teclados inline utilizados en la interacci\xf3n del usuario en el chat de telegram con el bot"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:"summary_pdf_button = InlineKeyboardButton(text=\"Subir un PDF\", callback_data='summary_pdf')\nchatting_button = InlineKeyboardButton(text=\"Interactuar\", callback_data='chatting')\nkeyboard = InlineKeyboardMarkup(inline_keyboard=[[summary_pdf_button]])\nkeyboard2 = InlineKeyboardMarkup(inline_keyboard=[[chatting_button]])\n"})}),"\n",(0,o.jsx)(n.h2,{id:"manejo-de-callbacks",children:"Manejo de Callbacks"}),"\n",(0,o.jsx)(n.p,{children:"Manejo de callbacks para cambiar el modo de interacci\xf3n del usuario."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:"@dp.callback_query_handler(lambda callback_query: True)\nasync def button_handler(callback_query: types.CallbackQuery):\n    global MODE\n    user_id = callback_query.from_user.id\n    MODE[user_id] = callback_query.data\n\n    with open('MODE.json', 'w') as file:\n        json.dump(MODE, file)\n\n    await bot.answer_callback_query(callback_query.id, text=f\"Current mode: {MODE[user_id]}\")\n"})}),"\n",(0,o.jsx)(n.h2,{id:"manejo-de-comandos",children:"Manejo de Comandos"}),"\n",(0,o.jsx)(n.p,{children:"Respuesta al comando /start para iniciar la interacci\xf3n con el bot."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:"@dp.message_handler(commands=['start'])\nasync def cmd_start(msg: types.Message) -> None:\n    global MODE\n    user_id = msg.from_user.id\n\n    save_user(user_id, msg.from_user.first_name)\n\n    if user_id not in MODE:\n        MODE[user_id] = 'chatting'\n    if user_id not in USER_STATES:\n        USER_STATES[user_id] = 0\n\n    reply_text = f\"\xa1Hola, {msg.from_user.first_name}! \u2764\ufe0f. Soy NotesHub, un chatbot de inteligencia artificial. Recibo tus documentos pdf y luego interact\xfaas sobre ellos conmigo. An\xedmate a probarme.\\nEn el futuro tendr\xe9 m\xe1s funcionalidades, pero para seguir mejorando necesito seguir aprendiendo de ti y tus interacciones. As\xed que \xbfPor qu\xe9 no comenzamos?\"\n    await bot.send_message(msg.chat.id, reply_text, reply_markup=keyboard)\n"})}),"\n",(0,o.jsx)(n.h2,{id:"funciones-de-procesamiento-de-texto",children:"Funciones de Procesamiento de Texto"}),"\n",(0,o.jsx)(n.p,{children:"Funciones auxiliares para el c\xe1lculo de tokens y costos asociados al procesamiento."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:"# Funci\xf3n para calcular el n\xfamero de tokens\ndef calc_n_tokens(text):\n    encode = enc.encode(text)\n    return len(encode)\n\n# Funci\xf3n para calcular el costo asociado al resumen\ndef calc_total_cost(n_tokens):\n    return float(str(n_tokens * cost_by_in_token + n_tokens * cost_by_out_token))\n"})}),"\n",(0,o.jsx)(n.h2,{id:"manejo-de-mensajes-de-usuario",children:"Manejo de Mensajes de Usuario"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:'@dp.message_handler(content_types=ContentType.TEXT)\nasync def handle_text(message: types.Message):\n    user_input = message.text\n    user_id = message.from_user.id\n\n    if MODE[user_id] == "chatting":\n        # L\xf3gica para manejar mensajes de texto en el modo "chatting"\n    else:\n        await message.answer("Por favor, suba un PDF. Si ya lo hizo y desea chatear, cambie de modo utilizando el comando /change_mode.")\n'})}),"\n",(0,o.jsx)(n.h2,{id:"manejo-de-documentos-pdf",children:"Manejo de Documentos PDF"}),"\n",(0,o.jsx)(n.p,{children:"Manejo de documentos PDF y l\xf3gica asociada para el resumen."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:'@dp.message_handler(content_types=ContentType.DOCUMENT)\nasync def handle_document(message: types.Message):\n    document = message.document\n    user_id = message.from_user.id\n    file_size = document.file_size\n    file_name = document.file_name\n    sentences_per_group = 4\n\n    if is_summary_limit_positive(user_id):\n        # L\xf3gica para manejar documentos PDF\n        ...\n    else:\n        await message.answer("Ha alcanzado el m\xe1ximo de PDFs procesados de su prueba gratuita \ud83d\ude07. \xbfDesear\xeda adquirir la versi\xf3n de pago de NotesHub?")\n'})}),"\n",(0,o.jsx)(n.h2,{id:"inicializaci\xf3n-y-ejecuci\xf3n-del-bot",children:"Inicializaci\xf3n y Ejecuci\xf3n del Bot"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-py",children:"if __name__ == '__main__':\n    MODE = {}\n    USER_STATES = {}\n    QUERY_STATE = {}\n    OTHER_MODE = {}\n\n    if os.path.getsize(\"MODE.json\") >\n\n"})})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},1151:(e,n,a)=>{a.d(n,{Z:()=>r,a:()=>s});var o=a(7294);const i={},t=o.createContext(i);function s(e){const n=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(t.Provider,{value:n},e.children)}}}]);